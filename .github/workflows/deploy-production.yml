name: Deploy Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # Step 1: Backup .env files
      - name: Backup .env files
        run: |
          if (Test-Path "backend\.env") {
            Copy-Item "backend\.env" "backend\.env.backup" -Force
            Write-Host "‚úÖ Backend .env backed up"
          }
          if (Test-Path "frontend\.env") {
            Copy-Item "frontend\.env" "frontend\.env.backup" -Force
            Write-Host "‚úÖ Frontend .env backed up"
          }
        continue-on-error: true

      # Step 2: Checkout the latest production code
      - name: Checkout latest production code
        uses: actions/checkout@v3
        with:
          ref: production
          clean: true

      # Step 3: Restore .env files
      - name: Restore .env files
        run: |
          if (Test-Path "backend\.env.backup") {
            Copy-Item "backend\.env.backup" "backend\.env" -Force
            Remove-Item "backend\.env.backup" -Force
            Write-Host "‚úÖ Backend .env restored"
          }
          if (Test-Path "frontend\.env.backup") {
            Copy-Item "frontend\.env.backup" "frontend\.env" -Force
            Remove-Item "frontend\.env.backup" -Force
            Write-Host "‚úÖ Frontend .env restored"
          }
        continue-on-error: true

      # Step 4: Verify current branch
      - name: Verify Current Branch
        run: |
          git branch -a
          git status

      # Step 5: Install backend dependencies
      - name: Install backend deps
        run: |
          cd backend
          npm install
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Backend npm install failed"
            exit 1
          }

      # Step 6: Build backend (TS ‚Üí dist)
      - name: Build backend (TS ‚Üí dist)
        run: |
          cd backend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Backend build failed"
            exit 1
          }

      # Step 7: Install frontend dependencies
      - name: Install frontend deps
        run: |
          cd frontend
          npm install
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend npm install failed"
            exit 1
          }

      # Step 8: Build frontend (Vite ‚Üí dist)
      - name: Build frontend (Vite ‚Üí dist)
        run: |
          cd frontend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend build failed"
            exit 1
          }

      # Step 9: Restart the backend with PM2
      - name: Restart Backend
        run: |
          cd backend
          
          $processExists = pm2 list | Select-String "ayan-backend"
          
          if ($processExists) {
            Write-Host "Stopping and deleting existing ayan-backend..."
            pm2 delete ayan-backend
          } else {
            Write-Host "No existing process found, starting fresh..."
          }
          
          Write-Host "Starting ayan-backend..."
          pm2 start ecosystem.config.cjs
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to start PM2 process"
            exit 1
          }
          
          Write-Host "‚úÖ Backend started successfully" -ForegroundColor Green

      # Step 10: Wait for app to start
      - name: Wait for app startup
        run: |
          Write-Host "Waiting for app to start..."
          Start-Sleep -Seconds 5

      # Step 11: Verify PM2 process is running
      - name: Verify PM2 Process Status
        run: |
          cd backend
          Write-Host "Checking PM2 status..."
          
          $pidOutput = pm2 pid ayan-backend
          $appPid = $pidOutput.Trim()
          
          if ([string]::IsNullOrWhiteSpace($appPid) -or $appPid -eq "0") {
            Write-Error "‚ùå ayan-backend is not running"
            Write-Host "`nShowing PM2 list:"
            pm2 list
            Write-Host "`nShowing recent logs:"
            pm2 logs ayan-backend --lines 50 --nostream
            exit 1
          }
          
          Write-Host "‚úÖ PM2 process is running successfully" -ForegroundColor Green
          Write-Host "Process ID: $appPid"
          pm2 list

      # Step 12: Health check - Test if app responds
      - name: Health Check - Test App Response
        run: |
          $port = 8000
          $healthEndpoint = "http://localhost:$port/"
          
          Write-Host "Testing app health at $healthEndpoint..."
          
          $maxAttempts = 5
          $success = $false
          
          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
            Write-Host "Attempt $attempt of $maxAttempts..."
            
            try {
              $response = Invoke-RestMethod -Uri $healthEndpoint -Method Get -TimeoutSec 5 -ErrorAction Stop
              
              if ($response.status -eq $true) {
                Write-Host "‚úÖ Health check passed! App is healthy." -ForegroundColor Green
                Write-Host "Response: $($response | ConvertTo-Json -Compress)"
                $success = $true
                break
              } else {
                Write-Host "‚ö†Ô∏è  App responded but status is not true" -ForegroundColor Yellow
              }
            } catch {
              Write-Host "‚ö†Ô∏è  Attempt $attempt failed: $($_.Exception.Message)" -ForegroundColor Yellow
              
              if ($attempt -lt $maxAttempts) {
                Write-Host "Retrying in 3 seconds..."
                Start-Sleep -Seconds 3
              }
            }
          }
          
          if (-not $success) {
            Write-Error "‚ùå Health check failed after $maxAttempts attempts"
            Write-Host "`nShowing recent logs:"
            pm2 logs ayan-backend --lines 50 --nostream
            exit 1
          }

      # Step 13: Save PM2 configuration
      - name: Save PM2 Configuration
        run: |
          pm2 save
          Write-Host "‚úÖ PM2 configuration saved"

      # Step 14: Deployment summary
      - name: Deployment Summary
        run: |
          Write-Host "`n================================" -ForegroundColor Cyan
          Write-Host "üöÄ DEPLOYMENT SUCCESSFUL" -ForegroundColor Green
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "`nPM2 Status:"
          pm2 list