name: Deploy Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: self-hosted

    steps:

      # 1. Checkout latest production code
      - name: Checkout Production Branch
        uses: actions/checkout@v3
        with:
          ref: production
          clean: false


      # 2. Install backend dependencies
      - name: Install Backend Dependencies
        shell: powershell
        run: |
          cd backend
          npm ci
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Backend dependency installation failed"
            exit 1
          }


      # 3. Build backend
      - name: Build Backend
        shell: powershell
        run: |
          cd backend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Backend build failed"
            exit 1
          }


      # 4. Install frontend dependencies
      - name: Install Frontend Dependencies
        shell: powershell
        run: |
          cd frontend
          npm ci
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend dependency installation failed"
            exit 1
          }


      # 5. Build frontend
      - name: Build Frontend
        shell: powershell
        run: |
          cd frontend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend build failed"
            exit 1
          }


      # 6. Verify frontend dist exists
      - name: Verify Frontend Dist
        shell: powershell
        run: |
          if (!(Test-Path "frontend\dist\index.html")) {
            Write-Error "frontend/dist/index.html NOT found"
            exit 1
          }

          Write-Host "Frontend dist verified successfully"
          dir frontend\dist


      # 7. Reload backend safely with PM2 (Zero Downtime)
      - name: Reload Backend with PM2
        shell: powershell
        run: |
          cd backend

          Write-Host "Reloading backend with PM2..."

          pm2 reload ecosystem.config.cjs --only ayan-backend --update-env 2>$null

          if ($LASTEXITCODE -ne 0) {
            Write-Host "Process not running. Starting fresh..."
            pm2 start ecosystem.config.cjs --only ayan-backend --update-env
          }

          if ($LASTEXITCODE -ne 0) {
            Write-Error "PM2 start/reload failed"
            pm2 logs ayan-backend --lines 50 --nostream
            exit 1
          }

          pm2 save
          Write-Host "PM2 process running successfully"


      # 8. Wait for application startup
      - name: Wait for Startup
        shell: powershell
        run: |
          Write-Host "Waiting for application startup..."
          Start-Sleep -Seconds 8

      # 9. Deployment summary
      - name: Deployment Summary
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "======================================"
          Write-Host "DEPLOYMENT SUCCESSFUL"
          Write-Host "======================================"
          pm2 list
