name: Deploy Production

on:
  push:
    branches:
      - production
      - production

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # Step 1: Checkout the latest production code
      - name: Checkout latest production code
        uses: actions/checkout@v3
        with:
          ref: production
          clean: true  # Clean the workspace before checkout

      # Step 2: Verify current branch and location
      - name: Verify Current Branch and Directory
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Files in current directory:"
          Get-ChildItem
          git branch -a
          git status

      # Step 3: Install backend dependencies
      - name: Install backend deps
        run: |
          cd backend
          npm install

      # Step 4: Build backend (TS → dist)
      - name: Build backend (TS → dist)
        run: |
          cd backend
          npm run build

      # Step 5: Install frontend dependencies
      - name: Install frontend deps
        run: |
          cd frontend
          npm install

      # Step 6: Build frontend (Vite → dist)
      - name: Build frontend (Vite → dist)
        run: |
          cd frontend
          npm run build

      # Step 7: Copy built files to production directory
      - name: Copy to production directory
        run: |
          # Create production directory if it doesn't exist
          New-Item -ItemType Directory -Force -Path D:\apps\ayan-ms
          
          # Copy backend
          Copy-Item -Path ".\backend\*" -Destination "D:\apps\ayan-ms\backend" -Recurse -Force
          
          # Copy frontend
          Copy-Item -Path ".\frontend\*" -Destination "D:\apps\ayan-ms\frontend" -Recurse -Force

      # Step 8: Restart the backend with PM2
      - name: Restart Backend
        run: |
          cd D:\apps\ayan-ms\backend
          $pm2List = pm2 list
          if ($pm2List -match "ayan-backend") {
            pm2 restart ayan-backend
          } else {
            pm2 start ecosystem.config.cjs
          }