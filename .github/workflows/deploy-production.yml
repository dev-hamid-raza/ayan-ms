name: Deploy Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # Step 1: Checkout the code
      - name: Checkout latest production code
        uses: actions/checkout@v2

      # Step 2: Install backend dependencies
      - name: Install backend deps
        run: |
          cd D:\apps\ayan-ms\backend
          npm install

      # Step 3: Build backend (TS → dist)
      - name: Build backend (TS → dist)
        run: |
          cd D:\apps\ayan-ms\backend
          npm run build

      # Step 4: Install frontend dependencies
      - name: Install frontend deps
        run: |
          cd D:\apps\ayan-ms\frontend
          npm install

      # Step 5: Build frontend (Vite → dist)
      - name: Build frontend (Vite → dist)
        run: |
          cd D:\apps\ayan-ms\frontend
          npm run build

      # Step 6: Restart the backend with PM2
      - name: Restart Backend
        run: |
          cd D:\apps\ayan-ms\backend
          if (pm2 list | Select-String "ayan-backend") {
            pm2 restart ayan-backend
          } else {
            pm2 start ecosystem.config.js
          }
