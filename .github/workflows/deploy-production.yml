name: Deploy Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # Step 1: Checkout the latest production code
      - name: Checkout latest production code
        uses: actions/checkout@v3
        with:
          ref: production

      # Step 2: Verify current branch
      - name: Verify Current Branch
        run: |
          git branch -a
          git status

      # Step 3: Install backend dependencies
      - name: Install backend deps
        run: |
          cd backend
          npm install
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Backend npm install failed"
            exit 1
          }

      # Step 4: Build backend (TS ‚Üí dist)
      - name: Build backend (TS ‚Üí dist)
        run: |
          cd backend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Backend build failed"
            exit 1
          }

      # Step 5: Install frontend dependencies
      - name: Install frontend deps
        run: |
          cd frontend
          npm install
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend npm install failed"
            exit 1
          }

      # Step 6: Build frontend (Vite ‚Üí dist)
      - name: Build frontend (Vite ‚Üí dist)
        run: |
          cd frontend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend build failed"
            exit 1
          }

      # Step 7: Restart the backend with PM2
      - name: Restart Backend
        run: |
          cd backend
          
          # Check if ayan-backend process exists
          $processExists = pm2 list | Select-String "ayan-backend"
          
          if ($processExists) {
            Write-Host "Stopping and deleting existing ayan-backend..."
            pm2 delete ayan-backend
          } else {
            Write-Host "No existing process found, starting fresh..."
          }
          
          # Start the application
          Write-Host "Starting ayan-backend..."
          pm2 start ecosystem.config.cjs
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to start PM2 process"
            exit 1
          }
          
          Write-Host "‚úÖ Backend started successfully" -ForegroundColor Green

      # Step 8: Wait for app to start
      - name: Wait for app startup
        run: |
          Write-Host "Waiting for app to start..."
          Start-Sleep -Seconds 5

      # Step 9: Verify PM2 process is running
      - name: Verify PM2 Process Status
        run: |
          cd backend
          Write-Host "Checking PM2 status..."
          
          # Get the process ID (returns 0 if not running)
          $pidOutput = pm2 pid ayan-backend
          $appPid = $pidOutput.Trim()
          
          if ([string]::IsNullOrWhiteSpace($appPid) -or $appPid -eq "0") {
            Write-Error "‚ùå ayan-backend is not running"
            Write-Host "`nShowing PM2 list:"
            pm2 list
            Write-Host "`nShowing recent logs:"
            pm2 logs ayan-backend --lines 50 --nostream
            exit 1
          }
          
          Write-Host "‚úÖ PM2 process is running successfully" -ForegroundColor Green
          Write-Host "Process ID: $appPid"
          pm2 list

      # Step 10: Health check - Test if app responds
      - name: Health Check - Test App Response
        run: |
          $port = 8000  # Change to your actual port
          
          Write-Host "Testing app on port $port..."
          
          $maxAttempts = 5
          $attempt = 0
          $success = $false
          
          while ($attempt -lt $maxAttempts -and -not $success) {
            $attempt++
            Write-Host "Attempt $attempt of $maxAttempts..."
            
            try {
              $testConnection = Test-NetConnection -ComputerName localhost -Port $port -WarningAction SilentlyContinue
              if ($testConnection.TcpTestSucceeded) {
                Write-Host "‚úÖ App is responding on port $port!" -ForegroundColor Green
                $success = $true
              }
            } catch {
              Write-Host "‚ö†Ô∏è  Attempt $attempt failed" -ForegroundColor Yellow
            }
            
            if (-not $success -and $attempt -lt $maxAttempts) {
              Write-Host "Retrying in 3 seconds..."
              Start-Sleep -Seconds 3
            }
          }
          
          if (-not $success) {
            Write-Error "‚ùå Health check failed - app not responding on port $port"
            Write-Host "`nShowing recent logs:"
            pm2 logs ayan-backend --lines 50 --nostream
            exit 1
          }

      # Step 11: Save PM2 configuration
      - name: Save PM2 Configuration
        run: |
          pm2 save
          Write-Host "‚úÖ PM2 configuration saved"

      # Step 12: Deployment summary
      - name: Deployment Summary
        run: |
          Write-Host "`n================================" -ForegroundColor Cyan
          Write-Host "üöÄ DEPLOYMENT SUCCESSFUL" -ForegroundColor Green
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "`nPM2 Status:"
          pm2 list