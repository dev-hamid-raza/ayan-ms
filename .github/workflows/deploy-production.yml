name: Deploy Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: self-hosted

    steps:

      # 1Ô∏è‚É£ Checkout latest production branch
      - name: Checkout Production Branch
        uses: actions/checkout@v3
        with:
          ref: production
          clean: true


      # 2Ô∏è‚É£ Create backend .env from GitHub Secret
      - name: Create Backend .env
        run: |
          Set-Content -Path backend\.env -Value "${{ secrets.BACKEND_ENV }}"
          Write-Host "‚úÖ Backend .env created"


      # 3Ô∏è‚É£ Create frontend .env from GitHub Secret
      - name: Create Frontend .env
        run: |
          Set-Content -Path frontend\.env -Value "${{ secrets.FRONTEND_ENV }}"
          Write-Host "‚úÖ Frontend .env created"


      # 4Ô∏è‚É£ Install backend dependencies
      - name: Install Backend Dependencies
        run: |
          cd backend
          npm ci
          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Backend dependency install failed"
            exit 1
          }


      # 5Ô∏è‚É£ Build backend
      - name: Build Backend
        run: |
          cd backend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Backend build failed"
            exit 1
          }


      # 6Ô∏è‚É£ Install frontend dependencies
      - name: Install Frontend Dependencies
        run: |
          cd frontend
          npm ci
          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Frontend dependency install failed"
            exit 1
          }


      # 7Ô∏è‚É£ Build frontend
      - name: Build Frontend
        run: |
          cd frontend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå Frontend build failed"
            exit 1
          }


      # 8Ô∏è‚É£ Restart backend safely with PM2
      - name: Restart Backend with PM2
        run: |
          cd backend

          Write-Host "üîÑ Cleaning old PM2 process (if exists)..."
          pm2 delete ayan-backend 2>$null

          Write-Host "üöÄ Starting ayan-backend..."
          pm2 start ecosystem.config.cjs --only ayan-backend --update-env

          if ($LASTEXITCODE -ne 0) {
            Write-Error "‚ùå PM2 start failed"
            pm2 logs ayan-backend --lines 50 --nostream
            exit 1
          }

          pm2 save
          Write-Host "‚úÖ PM2 process started successfully"


      # 9Ô∏è‚É£ Wait for app startup
      - name: Wait for Startup
        run: |
          Write-Host "‚è≥ Waiting for app to start..."
          Start-Sleep -Seconds 5


      # üîü Health check
      - name: Health Check
        run: |
          $port = 8000
          $url = "http://localhost:$port/"

          Write-Host "üîé Testing health at $url"

          $maxAttempts = 5
          $success = $false

          for ($i = 1; $i -le $maxAttempts; $i++) {

            try {
              $response = Invoke-RestMethod -Uri $url -Method Get -TimeoutSec 5 -ErrorAction Stop

              if ($response.status -eq $true) {
                Write-Host "‚úÖ Health check passed!"
                $success = $true
                break
              }

            } catch {
              Write-Host "‚ö†Ô∏è Attempt $i failed..."
              Start-Sleep -Seconds 3
            }
          }

          if (-not $success) {
            Write-Error "‚ùå Health check failed"
            pm2 logs ayan-backend --lines 100 --nostream
            exit 1
          }


      # 1Ô∏è‚É£1Ô∏è‚É£ Deployment Summary
      - name: Deployment Summary
        run: |
          Write-Host ""
          Write-Host "======================================"
          Write-Host "üöÄ DEPLOYMENT SUCCESSFUL"
          Write-Host "======================================"
          pm2 list
