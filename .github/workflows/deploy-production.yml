name: Deploy Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1Ô∏è‚É£ Checkout latest code (clean safe)
      - name: Checkout production branch
        uses: actions/checkout@v3
        with:
          ref: production
          clean: true

      # 2Ô∏è‚É£ Create backend .env from GitHub Secret
      - name: Create backend .env
        run: |
          Set-Content -Path backend\.env -Value "${{ secrets.BACKEND_ENV }}"
          Write-Host "‚úÖ Backend .env created"

      # 3Ô∏è‚É£ Create frontend .env from GitHub Secret
      - name: Create frontend .env
        run: |
          Set-Content -Path frontend\.env -Value "${{ secrets.FRONTEND_ENV }}"
          Write-Host "‚úÖ Frontend .env created"

      # 4Ô∏è‚É£ Install backend dependencies
      - name: Install backend dependencies
        run: |
          cd backend
          npm ci
          if ($LASTEXITCODE -ne 0) { exit 1 }

      # 5Ô∏è‚É£ Build backend
      - name: Build backend
        run: |
          cd backend
          npm run build
          if ($LASTEXITCODE -ne 0) { exit 1 }

      # 6Ô∏è‚É£ Install frontend dependencies
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
          if ($LASTEXITCODE -ne 0) { exit 1 }

      # 7Ô∏è‚É£ Build frontend
      - name: Build frontend
        run: |
          cd frontend
          npm run build
          if ($LASTEXITCODE -ne 0) { exit 1 }

      # 8Ô∏è‚É£ Restart backend with PM2 (zero duplicate process)
      - name: Restart Backend with PM2
        run: |
          cd backend

          $exists = pm2 list | Select-String "ayan-backend"

          if ($exists) {
            Write-Host "Restarting ayan-backend..."
            pm2 restart ayan-backend
          } else {
            Write-Host "Starting ayan-backend..."
            pm2 start ecosystem.config.cjs
          }

          if ($LASTEXITCODE -ne 0) { exit 1 }

      # 9Ô∏è‚É£ Wait for app startup
      - name: Wait for startup
        run: Start-Sleep -Seconds 5

      # üîü Health check
      - name: Health Check
        run: |
          $port = 8000
          $url = "http://localhost:$port/"

          Write-Host "Checking health at $url"

          try {
            $response = Invoke-RestMethod -Uri $url -Method Get -TimeoutSec 5
            if ($response.status -ne $true) {
              Write-Error "App unhealthy"
              exit 1
            }
            Write-Host "‚úÖ App is healthy"
          } catch {
            Write-Error "Health check failed"
            pm2 logs ayan-backend --lines 50 --nostream
            exit 1
          }

      # 1Ô∏è‚É£1Ô∏è‚É£ Save PM2 state
      - name: Save PM2
        run: pm2 save

      # 1Ô∏è‚É£2Ô∏è‚É£ Deployment summary
      - name: Deployment Summary
        run: |
          Write-Host "================================"
          Write-Host "üöÄ DEPLOYMENT SUCCESSFUL"
          Write-Host "================================"
          pm2 list
