name: Deploy Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: self-hosted

    steps:

      # 1. Checkout latest production code
      - name: Checkout Production Branch
        uses: actions/checkout@v3
        with:
          ref: production
          clean: true


      # 2. Create backend .env
      - name: Create Backend .env
        shell: powershell
        run: |
          Set-Content -Path "backend\.env" -Value "${{ secrets.BACKEND_ENV }}"
          Write-Host "Backend .env created successfully"


      # 3. Create frontend .env
      - name: Create Frontend .env
        shell: powershell
        run: |
          Set-Content -Path "frontend\.env" -Value "${{ secrets.FRONTEND_ENV }}"
          Write-Host "Frontend .env created successfully"


      # 4. Install backend dependencies
      - name: Install Backend Dependencies
        shell: powershell
        run: |
          cd backend
          npm ci
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Backend dependency installation failed"
            exit 1
          }


      # 5. Build backend
      - name: Build Backend
        shell: powershell
        run: |
          cd backend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Backend build failed"
            exit 1
          }


      # 6. Install frontend dependencies
      - name: Install Frontend Dependencies
        shell: powershell
        run: |
          cd frontend
          npm ci
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend dependency installation failed"
            exit 1
          }


      # 7. Build frontend
      - name: Build Frontend
        shell: powershell
        run: |
          cd frontend
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend build failed"
            exit 1
          }


      # 8. Verify frontend dist exists
      - name: Verify Frontend Dist
        shell: powershell
        run: |
          if (!(Test-Path "frontend\dist\index.html")) {
            Write-Error "frontend/dist/index.html NOT found"
            exit 1
          }

          Write-Host "Frontend dist verified successfully"
          dir frontend\dist


      # 9. Restart backend safely with PM2
      - name: Restart Backend with PM2
        shell: powershell
        run: |
          cd backend

          Write-Host "Stopping old process if exists..."
          pm2 delete ayan-backend 2>$null

          Write-Host "Starting backend..."
          pm2 start ecosystem.config.cjs --only ayan-backend --update-env

          if ($LASTEXITCODE -ne 0) {
            Write-Error "PM2 start failed"
            pm2 logs ayan-backend --lines 50 --nostream
            exit 1
          }

          pm2 save
          Write-Host "PM2 process started successfully"


      # 10. Wait for application startup
      - name: Wait for Startup
        shell: powershell
        run: |
          Write-Host "Waiting for application startup..."
          Start-Sleep -Seconds 5


      # 11. Health check
      - name: Health Check
        shell: powershell
        run: |
          $port = 8000
          $url = "http://localhost:$port/health"

          Write-Host "Testing health at $url"

          $maxAttempts = 5
          $success = $false

          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              $response = Invoke-RestMethod -Uri $url -Method Get -TimeoutSec 5 -ErrorAction Stop

              if ($response.status -eq $true) {
                Write-Host "Health check passed"
                $success = $true
                break
              }

            } catch {
              Write-Host "Attempt $i failed"
              Start-Sleep -Seconds 3
            }
          }

          if (-not $success) {
            Write-Error "Health check failed"
            pm2 logs ayan-backend --lines 100 --nostream
            exit 1
          }


      # 12. Deployment summary
      - name: Deployment Summary
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "======================================"
          Write-Host "DEPLOYMENT SUCCESSFUL"
          Write-Host "======================================"
          pm2 list
